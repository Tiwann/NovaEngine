SET(ENGINE_MODULES Core)

#[[ GLFW ]]
OPTION(GLFW_BUILD_DOCS OFF)
OPTION(GLFW_BUILD_TESTS OFF)
OPTION(GLFW_BUILD_EXAMPLES OFF)
OPTION(BUILD_SHARED_LIBS OFF)
OPTION(GLFW_INSTALL OFF)
ADD_SUBDIRECTORY(Dependencies/glfw)

#[[ ASSIMP ]]
OPTION(ASSIMP_BUILD_TESTS OFF)
OPTION(ASSIMP_INSTALL OFF)
OPTION(ASSIMP_INSTALL_PDB OFF)
OPTION(ASSIMP_BUILD_ALL_EXPORTERS_BY_DEFAULT OFF)
OPTION(ASSIMP_BUILD_ALL_IMPORTERS_BY_DEFAULT OFF)

SET(ASSIMP_BUILD_FBX_EXPORTER   ON CACHE BOOL "" FORCE)
SET(ASSIMP_BUILD_OBJ_EXPORTER   ON CACHE BOOL "" FORCE)
SET(ASSIMP_BUILD_GLTF_EXPORTER  ON CACHE BOOL "" FORCE)

SET(ASSIMP_BUILD_FBX_IMPORTER   ON CACHE BOOL "" FORCE)
SET(ASSIMP_BUILD_OBJ_IMPORTER   ON CACHE BOOL "" FORCE)
SET(ASSIMP_BUILD_GLTF_IMPORTER  ON CACHE BOOL "" FORCE)

ADD_SUBDIRECTORY(Dependencies/assimp)


#[[ BOX2D ]]
OPTION(BOX2D_BUILD_DOCS OFF)
OPTION(BOX2D_BUILD_TESTBED OFF)
OPTION(BOX2D_BUILD_UNIT_TESTS OFF)
OPTION(BOX2D_USER_SETTINGS OFF)
OPTION(BUILD_SHARED_LIBS OFF)
ADD_SUBDIRECTORY(Dependencies/box2d)

#[[ JOLT ]]
ADD_SUBDIRECTORY(Dependencies/Jolt/Build)

#[[ VMA ]]
ADD_SUBDIRECTORY(Dependencies/vma)

#[[ STB ]]
ADD_SUBDIRECTORY(Dependencies/stb)

#[[ IMGUI ]]
SET(IMGUI_DIR Dependencies/imgui)
ADD_LIBRARY(imgui STATIC
        ${IMGUI_DIR}/imconfig.h
        ${IMGUI_DIR}/imgui.cpp
        ${IMGUI_DIR}/imgui.h
        ${IMGUI_DIR}/imgui_demo.cpp
        ${IMGUI_DIR}/imgui_draw.cpp
        ${IMGUI_DIR}/imgui_internal.h
        ${IMGUI_DIR}/imgui_tables.cpp
        ${IMGUI_DIR}/imgui_widgets.cpp
        ${IMGUI_DIR}/imstb_rectpack.h
        ${IMGUI_DIR}/imstb_textedit.h
        ${IMGUI_DIR}/imstb_truetype.h
)
TARGET_INCLUDE_DIRECTORIES(imgui INTERFACE Dependencies/imgui)


FILE(GLOB_RECURSE SOURCES Source/*.cpp Source/*.h REMOVE_RECURSE Source/Platform/*.cpp Source/Platform/*.h)

if (CMAKE_SYSTEM_NAME STREQUAL "Windows")
    FILE(GLOB Source/Platform/Windows/*.cpp Source/Platform/Windows/*.h)
elseif (CMAKE_SYSTEM_NAME STREQUAL "Linux")
    FILE(GLOB Source/Platform/Linux/*.cpp Source/Platform/Linux/*.h)
else (CMAKE_SYSTEM_NAME STREQUAL "MacOS")
    FILE(GLOB Source/Platform/MacOS/*.cpp Source/Platform/MacOS/*.h)
endif ()

SET(CMAKE_CXX_STANDARD 20)
SET(CMAKE_CXX_STANDARD_REQUIRED ON)
ADD_LIBRARY(NovaEngine SHARED ${SOURCES})

TARGET_LINK_LIBRARIES(NovaEngine PUBLIC glfw VulkanMemoryAllocator box2d Jolt imgui)
TARGET_INCLUDE_DIRECTORIES(NovaEngine PUBLIC ${CMAKE_CURRENT_SOURCE_DIR}/Source)


SET_TARGET_PROPERTIES(NovaEngine PROPERTIES
        RUNTIME_OUTPUT_DIRECTORY "${CMAKE_SOURCE_DIR}/Binaries"
        ARCHIVE_OUTPUT_DIRECTORY "${CMAKE_SOURCE_DIR}/Binaries"
        LIBRARY_OUTPUT_DIRECTORY "${CMAKE_SOURCE_DIR}/Binaries"
)

FOREACH (MODULE ${ENGINE_MODULES})
    SET(MODULE_EXPORT_HEADER ${CMAKE_CURRENT_LIST_DIR}/ModuleExport.in.h)
    SET(HEADER_FILE ${CMAKE_BINARY_DIR}/Include/${MODULE}Export.h)
    FILE(READ ${MODULE_EXPORT_HEADER} HEADER_CONTENTS)
    STRING(TOUPPER ${MODULE} MODULE_UPPER)
    STRING(REPLACE "@MODULE_NAME@" ${MODULE_UPPER} HEADER_CONTENTS ${HEADER_CONTENTS})
    FILE(WRITE ${HEADER_FILE} ${HEADER_CONTENTS})

    TARGET_COMPILE_DEFINITIONS(NovaEngine
            INTERFACE MODULE_SHARED
            INTERFACE MODULE_BUILD)

    TARGET_INCLUDE_DIRECTORIES(NovaEngine PUBLIC ${CMAKE_BINARY_DIR}/Include)
    TARGET_INCLUDE_DIRECTORIES(NovaEngine PUBLIC ${MODULE}/Public)
    TARGET_INCLUDE_DIRECTORIES(NovaEngine PRIVATE ${MODULE}/Private)
    TARGET_INCLUDE_DIRECTORIES(NovaEngine PRIVATE ${MODULE})
ENDFOREACH ()